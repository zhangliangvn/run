<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Marathon Training - Sub 4:30</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #5b5fde;
            --primary-dark: #4549b8;
            --success: #22c55e;
            --warning: #fb923c;
            --danger: #f87171;
            --bg: #0a0e27;
            --bg-card: #151935;
            --bg-card-hover: #1d2247;
            --text: #ffffff;
            --text-secondary: #94a3b8;
            --border: #2a3050;
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --weather-hot: #f87171;
            --weather-warm: #fb923c;
            --weather-cool: #60a5fa;
            --weather-cold: #a78bfa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(180deg, #0a0e27 0%, #151935 100%);
            color: var(--text);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
            overflow-x: hidden;
        }

        /* Mobile-first container */
        .container {
            width: 100%;
            max-width: 100%;
            padding: 0;
        }

        /* Header - Mobile optimized */
        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-card-hover) 100%);
            padding: 20px 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--warning) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Weather location info */
        .location-info {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* Today's workout - Mobile optimized */
        .today-section {
            padding: 16px;
            background: var(--bg);
        }

        .today-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-card-hover) 100%);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .today-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--warning) 50%, var(--primary) 100%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .today-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .today-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }

        .today-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .workout-main {
            margin: 20px 0;
        }

        .workout-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .workout-distance {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--warning);
            margin-bottom: 16px;
        }

        .workout-details {
            background: rgba(10, 14, 39, 0.5);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .detail-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 1rem;
            color: var(--text);
            line-height: 1.4;
        }

        /* Weather info in today card */
        .today-weather {
            background: rgba(10, 14, 39, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            border: 1px solid var(--border);
        }

        .weather-times {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .weather-time-slot {
            background: rgba(10, 14, 39, 0.4);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(42, 48, 80, 0.5);
        }

        .time-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .time-weather {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .time-temp {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .time-icon {
            font-size: 1.2rem;
        }

        .time-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: capitalize;
        }

        .temp-hot { color: var(--weather-hot); }
        .temp-warm { color: var(--weather-warm); }
        .temp-cool { color: var(--weather-cool); }
        .temp-cold { color: var(--weather-cold); }

        .weather-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .weather-temp {
            font-size: 2rem;
            font-weight: 700;
        }

        .weather-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: capitalize;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .weather-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }

        .weather-icon {
            font-size: 1.2rem;
        }

        /* Workout type badges */
        .workout-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .type-easy { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .type-interval { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .type-tempo { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
        .type-long { background: rgba(91, 95, 222, 0.2); color: #5b5fde; }
        .type-core { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .type-rest { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }

        /* Quick stats - Mobile cards */
        .stats-section {
            padding: 0 16px 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Week view - Horizontal scroll for mobile */
        .week-section {
            padding: 16px 0;
            background: var(--bg);
        }

        .section-title {
            padding: 0 16px;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }

        .week-scroll {
            overflow-x: auto;
            padding: 0 16px 16px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .week-scroll::-webkit-scrollbar {
            display: none;
        }

        .week-container {
            display: flex;
            gap: 12px;
            width: max-content;
        }

        .day-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            min-width: 140px;
            border: 1px solid var(--border);
            transition: transform 0.2s, background 0.2s;
        }

        .day-card:active {
            transform: scale(0.98);
            background: var(--bg-card-hover);
        }

        .day-card.is-today {
            background: linear-gradient(135deg, rgba(91, 95, 222, 0.2) 0%, rgba(91, 95, 222, 0.1) 100%);
            border: 2px solid var(--primary);
        }

        .day-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .day-date {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .day-workout {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }

        .day-distance {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 12px;
        }

        .day-weather {
            padding: 8px 12px;
            background: rgba(10, 14, 39, 0.5);
            border-radius: 8px;
            margin-top: 8px;
        }

        .day-weather-times {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }

        .day-time-slot {
            flex: 1;
            text-align: center;
        }

        .day-time-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .day-time-temp {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .day-time-icon {
            font-size: 0.85rem;
        }

        .day-temp {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .day-weather-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
        }

        .weather-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .weather-error {
            background: rgba(248, 113, 113, 0.1);
            color: var(--danger);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            text-align: center;
        }

        /* No workout state */
        .no-workout {
            text-align: center;
            padding: 40px 20px;
        }

        .no-workout h2 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .no-workout p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Loading state */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50vh;
            padding: 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .mini-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                border-radius: 16px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .week-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                width: 100%;
            }

            .day-card {
                min-width: unset;
            }
        }

        /* iOS specific optimizations */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-user-select: none;
                -webkit-touch-callout: none;
            }

            .day-card:active {
                -webkit-tap-highlight-color: rgba(91, 95, 222, 0.2);
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Copyright footer */
        .copyright-footer {
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 20px 16px;
            margin-top: 20px;
            text-align: center;
        }

        .copyright-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .copyright-logo {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .internal-use {
            font-size: 0.7rem;
            color: rgba(148, 163, 184, 0.7);
            font-style: italic;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏃‍♂️ Marathon Sub 4:30</h1>
            <p>Lịch tập luyện cá nhân</p>
            <div class="location-info" id="locationInfo">
                <span class="mini-spinner"></span>
                <span>Đang xác định vị trí...</span>
            </div>
        </div>

        <div id="mainContent">
            <div class="loading">
                <div class="spinner"></div>
                <p>Đang tải lịch tập...</p>
            </div>
        </div>

        <div class="copyright-footer">
            <div class="copyright-logo">METTAGRAM LLC</div>
            <div class="copyright-text">
                © 2025 Mettagram LLC. All rights reserved.<br>
                Marathon Training System - Version 1.0
            </div>
            <div class="internal-use">
                🔒 Phần mềm lưu hành nội bộ - Chỉ dành cho thành viên được ủy quyền
            </div>
        </div>
    </div>

    <script>
        // API key và cấu hình
        const WEATHER_API_KEY = 'a081a048aa37ae4fd7766c934e6ea158';
        const WEATHER_BASE_URL = 'https://api.openweathermap.org/data/2.5';
        
        // Cache thời tiết để tránh gọi API quá nhiều
        let weatherCache = {
            current: null,
            forecast: null,
            lastUpdate: null,
            location: null
        };
        
        // Thời gian cache (30 phút)
        const CACHE_DURATION = 30 * 60 * 1000;

        // Dữ liệu training được nhúng cố định từ file Excel
        const trainingData = [
            {"Date":"26/09/2025","Day":"Friday","Workout":"Easy","Distance":6,"Description":"6 km @6:30/km","Notes":"Shake-out before weekend long run"},
            {"Date":"27/09/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"28/09/2025","Day":"Sunday","Workout":"Long run","Distance":20,"Description":"20 km @6:20–6:30/km","Notes":"2 gels, salt GU 1 cap/45–60', fluids 500–750 ml/10–12 km."},
            {"Date":"29/09/2025","Day":"Monday","Workout":"Core","Distance":2,"Description":"Run 2–3 km + Core workout","Notes":""},
            {"Date":"30/09/2025","Day":"Tuesday","Workout":"Interval","Distance":8,"Description":"6 × 800m @4:40–4:50/km | Rest 2:30 jog","Notes":"High intensity VO2max session"},
            {"Date":"01/10/2025","Day":"Wednesday","Workout":"Easy","Distance":7,"Description":"7 km @6:30/km","Notes":""},
            {"Date":"02/10/2025","Day":"Thursday","Workout":"Core","Distance":2,"Description":"Run 2–3 km + Core workout","Notes":""},
            {"Date":"03/10/2025","Day":"Friday","Workout":"Tempo","Distance":8,"Description":"8 km @5:45–6:10/km","Notes":""},
            {"Date":"04/10/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"05/10/2025","Day":"Sunday","Workout":"Long run","Distance":24,"Description":"24 km @6:15–6:25/km","Notes":"Hydration and gels every 8–10 km"},
            {"Date":"06/10/2025","Day":"Monday","Workout":"Core","Distance":3,"Description":"Run 3 km + Core workout","Notes":""},
            {"Date":"07/10/2025","Day":"Tuesday","Workout":"Interval","Distance":10,"Description":"8 × 600m @4:30–4:40/km | Rest 2:00 jog","Notes":""},
            {"Date":"08/10/2025","Day":"Wednesday","Workout":"Easy","Distance":8,"Description":"8 km @6:30/km","Notes":""},
            {"Date":"09/10/2025","Day":"Thursday","Workout":"Core","Distance":3,"Description":"Run 3 km + Core workout","Notes":""},
            {"Date":"10/10/2025","Day":"Friday","Workout":"Tempo","Distance":10,"Description":"10 km @5:40–6:00/km","Notes":"Steady effort"},
            {"Date":"11/10/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"12/10/2025","Day":"Sunday","Workout":"Long run","Distance":26,"Description":"26 km @6:10–6:20/km","Notes":"Practice race nutrition strategy"},
            {"Date":"13/10/2025","Day":"Monday","Workout":"Core","Distance":3,"Description":"Run 3 km + Core workout","Notes":""},
            {"Date":"14/10/2025","Day":"Tuesday","Workout":"Interval","Distance":12,"Description":"5 × 1km @4:45–4:55/km | Rest 2:30 jog","Notes":""},
            {"Date":"15/10/2025","Day":"Wednesday","Workout":"Easy","Distance":8,"Description":"8 km @6:30/km","Notes":""},
            {"Date":"16/10/2025","Day":"Thursday","Workout":"Core","Distance":4,"Description":"Run 4 km + Core workout","Notes":""},
            {"Date":"17/10/2025","Day":"Friday","Workout":"Tempo","Distance":12,"Description":"12 km @5:35–5:55/km","Notes":"Progressive tempo"},
            {"Date":"18/10/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"19/10/2025","Day":"Sunday","Workout":"Long run","Distance":28,"Description":"28 km @6:05–6:15/km","Notes":"Full race simulation with nutrition"},
            {"Date":"20/10/2025","Day":"Monday","Workout":"Core","Distance":4,"Description":"Run 4 km + Core workout","Notes":""},
            {"Date":"21/10/2025","Day":"Tuesday","Workout":"Interval","Distance":12,"Description":"4 × 1200m @4:50–5:00/km | Rest 3:00 jog","Notes":""},
            {"Date":"22/10/2025","Day":"Wednesday","Workout":"Easy","Distance":9,"Description":"9 km @6:30/km","Notes":""},
            {"Date":"23/10/2025","Day":"Thursday","Workout":"Core","Distance":4,"Description":"Run 4 km + Core workout","Notes":""},
            {"Date":"24/10/2025","Day":"Friday","Workout":"Tempo","Distance":14,"Description":"14 km @5:30–5:50/km","Notes":"Marathon pace practice"},
            {"Date":"25/10/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"26/10/2025","Day":"Sunday","Workout":"Long run","Distance":30,"Description":"30 km @6:00–6:10/km","Notes":"Peak long run - full nutrition practice"},
            {"Date":"27/10/2025","Day":"Monday","Workout":"Core","Distance":4,"Description":"Run 4 km + Core workout","Notes":""},
            {"Date":"28/10/2025","Day":"Tuesday","Workout":"Interval","Distance":10,"Description":"6 × 800m @4:40–4:50/km | Rest 2:30 jog","Notes":"Maintain speed"},
            {"Date":"29/10/2025","Day":"Wednesday","Workout":"Easy","Distance":10,"Description":"10 km @6:30/km","Notes":""},
            {"Date":"30/10/2025","Day":"Thursday","Workout":"Core","Distance":4,"Description":"Run 4 km + Core workout","Notes":""},
            {"Date":"31/10/2025","Day":"Friday","Workout":"Tempo","Distance":12,"Description":"12 km @5:35–5:55/km","Notes":""},
            {"Date":"01/11/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"02/11/2025","Day":"Sunday","Workout":"Long run","Distance":32,"Description":"32 km @5:55–6:05/km","Notes":"Last peak long run"},
            {"Date":"03/11/2025","Day":"Monday","Workout":"Core","Distance":4,"Description":"Run 4 km + Core workout","Notes":""},
            {"Date":"04/11/2025","Day":"Tuesday","Workout":"Interval","Distance":8,"Description":"5 × 600m @4:30–4:40/km | Rest 2:00 jog","Notes":"Speed maintenance"},
            {"Date":"05/11/2025","Day":"Wednesday","Workout":"Easy","Distance":8,"Description":"8 km @6:30/km","Notes":""},
            {"Date":"06/11/2025","Day":"Thursday","Workout":"Core","Distance":3,"Description":"Run 3 km + Core workout","Notes":""},
            {"Date":"07/11/2025","Day":"Friday","Workout":"Tempo","Distance":10,"Description":"10 km @5:40–6:00/km","Notes":""},
            {"Date":"08/11/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"09/11/2025","Day":"Sunday","Workout":"Long run","Distance":25,"Description":"25 km @6:00–6:10/km","Notes":"Taper begins - reduced volume"},
            {"Date":"10/11/2025","Day":"Monday","Workout":"Core","Distance":3,"Description":"Run 3 km + Core workout","Notes":""},
            {"Date":"11/11/2025","Day":"Tuesday","Workout":"Interval","Distance":6,"Description":"4 × 400m @4:20–4:30/km | Rest 2:00 jog","Notes":"Sharp but short"},
            {"Date":"12/11/2025","Day":"Wednesday","Workout":"Easy","Distance":6,"Description":"6 km @6:30/km","Notes":""},
            {"Date":"13/11/2025","Day":"Thursday","Workout":"Core","Distance":2,"Description":"Run 2 km + Light core","Notes":""},
            {"Date":"14/11/2025","Day":"Friday","Workout":"Tempo","Distance":8,"Description":"8 km @5:45–6:10/km","Notes":"Race pace feel"},
            {"Date":"15/11/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"16/11/2025","Day":"Sunday","Workout":"Long run","Distance":20,"Description":"20 km @6:00–6:10/km","Notes":"Last long run before race"},
            {"Date":"17/11/2025","Day":"Monday","Workout":"Core","Distance":2,"Description":"Run 2 km + Light core","Notes":""},
            {"Date":"18/11/2025","Day":"Tuesday","Workout":"Interval","Distance":5,"Description":"3 × 400m @4:20–4:30/km | Rest 2:00 jog","Notes":"Stay sharp"},
            {"Date":"19/11/2025","Day":"Wednesday","Workout":"Easy","Distance":5,"Description":"5 km @6:30/km","Notes":""},
            {"Date":"20/11/2025","Day":"Thursday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"21/11/2025","Day":"Friday","Workout":"Easy","Distance":6,"Description":"6 km @6:30/km","Notes":"Pre-race shakeout"},
            {"Date":"22/11/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"23/11/2025","Day":"Sunday","Workout":"Long run","Distance":15,"Description":"15 km @6:10–6:20/km","Notes":"Final tune-up"},
            {"Date":"24/11/2025","Day":"Monday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":""},
            {"Date":"25/11/2025","Day":"Tuesday","Workout":"Easy","Distance":4,"Description":"4 km @6:30/km","Notes":"Stay loose"},
            {"Date":"26/11/2025","Day":"Wednesday","Workout":"Easy","Distance":3,"Description":"3 km @6:30/km + 4 × 100m strides","Notes":"Race week"},
            {"Date":"27/11/2025","Day":"Thursday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":"Hydrate well"},
            {"Date":"28/11/2025","Day":"Friday","Workout":"Easy","Distance":2,"Description":"2 km @6:30/km","Notes":"Final shakeout"},
            {"Date":"29/11/2025","Day":"Saturday","Workout":"Rest","Distance":0,"Description":"Rest day","Notes":"Race prep - early bed"},
            {"Date":"30/11/2025","Day":"Sunday","Workout":"RACE","Distance":42.195,"Description":"MARATHON RACE DAY","Notes":"Target: Sub 4:30 - Good luck!"}
        ];

        // Vị trí mặc định: Quận Liên Chiểu, Đà Nẵng, Việt Nam
        const DEFAULT_LOCATION = {
            lat: 16.0738,
            lon: 108.1477,
            name: 'Liên Chiểu, Đà Nẵng, VN'
        };

        // Weather functions
        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    console.log('Geolocation not supported, using default location');
                    resolve({
                        lat: DEFAULT_LOCATION.lat,
                        lon: DEFAULT_LOCATION.lon,
                        isDefault: true
                    });
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            isDefault: false
                        });
                    },
                    error => {
                        console.log('Geolocation error, using default location:', error);
                        resolve({
                            lat: DEFAULT_LOCATION.lat,
                            lon: DEFAULT_LOCATION.lon,
                            isDefault: true
                        });
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 phút
                    }
                );
            });
        }

        async function fetchCurrentWeather(lat, lon) {
            const response = await fetch(
                `${WEATHER_BASE_URL}/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=vi`
            );
            
            if (!response.ok) {
                throw new Error(`Weather API error: ${response.status}`);
            }
            
            return await response.json();
        }

        async function fetchWeatherForecast(lat, lon) {
            const response = await fetch(
                `${WEATHER_BASE_URL}/forecast?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=vi`
            );
            
            if (!response.ok) {
                throw new Error(`Weather API error: ${response.status}`);
            }
            
            return await response.json();
        }

        async function getLocationName(lat, lon) {
            try {
                const response = await fetch(
                    `${WEATHER_BASE_URL}/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=vi`
                );
                const data = await response.json();
                return `${data.name}, ${data.sys.country}`;
            } catch (error) {
                return 'Vị trí hiện tại';
            }
        }

        function getTemperatureColor(temp) {
            if (temp >= 30) return 'temp-hot';
            if (temp >= 25) return 'temp-warm';
            if (temp >= 15) return 'temp-cool';
            return 'temp-cold';
        }

        function getWeatherIcon(weatherCode, isDay = true) {
            const icons = {
                '01d': '☀️', '01n': '🌙',
                '02d': '⛅', '02n': '☁️',
                '03d': '☁️', '03n': '☁️',
                '04d': '☁️', '04n': '☁️',
                '09d': '🌧️', '09n': '🌧️',
                '10d': '🌦️', '10n': '🌧️',
                '11d': '⛈️', '11n': '⛈️',
                '13d': '🌨️', '13n': '🌨️',
                '50d': '🌫️', '50n': '🌫️'
            };
            return icons[weatherCode] || '🌤️';
        }

        async function loadWeatherData() {
            const locationInfo = document.getElementById('locationInfo');
            
            try {
                // Kiểm tra cache
                const now = Date.now();
                if (weatherCache.current && weatherCache.forecast && 
                    weatherCache.lastUpdate && 
                    (now - weatherCache.lastUpdate) < CACHE_DURATION) {
                    return weatherCache;
                }

                locationInfo.innerHTML = `
                    <span class="mini-spinner"></span>
                    <span>Đang xác định vị trí...</span>
                `;

                // Lấy vị trí hiện tại (hoặc vị trí mặc định)
                const location = await getCurrentLocation();
                
                locationInfo.innerHTML = `
                    <span class="mini-spinner"></span>
                    <span>Đang tải thời tiết...</span>
                `;

                // Lấy dữ liệu thời tiết
                let locationName;
                if (location.isDefault) {
                    locationName = DEFAULT_LOCATION.name;
                } else {
                    locationName = await getLocationName(location.lat, location.lon);
                }

                const [currentWeather, forecast] = await Promise.all([
                    fetchCurrentWeather(location.lat, location.lon),
                    fetchWeatherForecast(location.lat, location.lon)
                ]);

                // Cập nhật cache
                weatherCache = {
                    current: currentWeather,
                    forecast: forecast,
                    lastUpdate: now,
                    location: { ...location, name: locationName }
                };

                // Hiển thị thông tin vị trí với icon phù hợp
                const locationIcon = location.isDefault ? '📍' : '🎯';
                const locationText = location.isDefault ? `${locationIcon} ${locationName} (mặc định)` : `${locationIcon} ${locationName}`;
                
                locationInfo.innerHTML = locationText;

                return weatherCache;

            } catch (error) {
                console.error('Weather loading error:', error);
                
                // Khi có lỗi API, thử sử dụng vị trí mặc định
                try {
                    locationInfo.innerHTML = `
                        <span class="mini-spinner"></span>
                        <span>Thử vị trí mặc định...</span>
                    `;

                    const [currentWeather, forecast] = await Promise.all([
                        fetchCurrentWeather(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lon),
                        fetchWeatherForecast(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lon)
                    ]);

                    weatherCache = {
                        current: currentWeather,
                        forecast: forecast,
                        lastUpdate: Date.now(),
                        location: { 
                            lat: DEFAULT_LOCATION.lat, 
                            lon: DEFAULT_LOCATION.lon, 
                            name: DEFAULT_LOCATION.name,
                            isDefault: true 
                        }
                    };

                    locationInfo.innerHTML = `📍 ${DEFAULT_LOCATION.name} (mặc định)`;
                    return weatherCache;

                } catch (fallbackError) {
                    console.error('Fallback weather loading error:', fallbackError);
                    
                    locationInfo.innerHTML = `⚠️ Không thể tải thời tiết`;
                    return null;
                }
            }
        }

        function getRunningTimeForecasts(forecast, targetDate) {
            if (!forecast || !forecast.list) return null;
            
            const targetDateStr = targetDate.toISOString().split('T')[0];
            const dayForecasts = forecast.list.filter(item => {
                const itemDate = new Date(item.dt * 1000);
                const itemDateStr = itemDate.toISOString().split('T')[0];
                return itemDateStr === targetDateStr;
            });
            
            if (dayForecasts.length === 0) return null;
            
            // Tìm thời tiết cho khung giờ sáng (4-6h) - ưu tiên 6:00
            const morningForecast = dayForecasts.find(item => {
                const hour = new Date(item.dt * 1000).getHours();
                return hour === 6;
            }) || dayForecasts.find(item => {
                const hour = new Date(item.dt * 1000).getHours();
                return hour >= 3 && hour <= 9;
            });
            
            // Tìm thời tiết cho khung giờ chiều (17-18h) - ưu tiên 18:00
            const eveningForecast = dayForecasts.find(item => {
                const hour = new Date(item.dt * 1000).getHours();
                return hour === 18;
            }) || dayForecasts.find(item => {
                const hour = new Date(item.dt * 1000).getHours();
                return hour >= 15 && hour <= 21;
            });
            
            return {
                morning: morningForecast,
                evening: eveningForecast
            };
        }

        // Lấy thời tiết cho 2 khung giờ từ current weather (ước tính)
        function getCurrentRunningTimes(currentWeather) {
            if (!currentWeather) return null;
            
            const now = new Date();
            const currentHour = now.getHours();
            
            // Tạo ước tính cho sáng và chiều dựa trên thời tiết hiện tại
            // Sáng thường mát hơn 3-5°C, chiều nóng hơn 1-3°C
            const baseTemp = currentWeather.main.temp;
            
            let morningTemp, eveningTemp;
            
            if (currentHour >= 4 && currentHour <= 8) {
                // Hiện tại là sáng sớm - dùng nhiệt độ hiện tại cho sáng
                morningTemp = baseTemp;
                eveningTemp = baseTemp + 4; // Chiều sẽ nóng hơn
            } else if (currentHour >= 16 && currentHour <= 20) {
                // Hiện tại là chiều muộn - dùng nhiệt độ hiện tại cho chiều
                morningTemp = baseTemp - 4; // Sáng sẽ mát hơn
                eveningTemp = baseTemp;
            } else if (currentHour >= 12 && currentHour <= 16) {
                // Hiện tại là trưa - ước tính cả 2
                morningTemp = baseTemp - 3;
                eveningTemp = baseTemp + 1;
            } else {
                // Hiện tại là tối/đêm - ước tính cả 2
                morningTemp = baseTemp - 2;
                eveningTemp = baseTemp + 2;
            }
            
            return {
                morning: {
                    ...currentWeather,
                    main: {
                        ...currentWeather.main,
                        temp: morningTemp,
                        feels_like: morningTemp + (currentWeather.main.feels_like - currentWeather.main.temp)
                    }
                },
                evening: {
                    ...currentWeather,
                    main: {
                        ...currentWeather.main,
                        temp: eveningTemp,
                        feels_like: eveningTemp + (currentWeather.main.feels_like - currentWeather.main.temp)
                    }
                }
            };
        }

        // Parse dates and prepare data
        function parseDate(dateStr) {
            const parts = dateStr.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        // Get today's date (no time)
        function getToday() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }

        // Format date for display
        function formatDate(date) {
            const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            return {
                dayName: days[date.getDay()],
                dateStr: `${date.getDate()}/${months[date.getMonth()]}`
            };
        }

        // Get workout type class
        function getWorkoutClass(workout) {
            const type = workout.toLowerCase();
            if (type.includes('easy')) return 'type-easy';
            if (type.includes('interval')) return 'type-interval';
            if (type.includes('tempo')) return 'type-tempo';
            if (type.includes('long')) return 'type-long';
            if (type.includes('core')) return 'type-core';
            if (type.includes('rest')) return 'type-rest';
            if (type.includes('race')) return 'type-interval';
            return 'type-easy';
        }

        // Find today's workout
        function getTodayWorkout() {
            const today = getToday();
            return trainingData.find(workout => {
                const workoutDate = parseDate(workout.Date);
                workoutDate.setHours(0, 0, 0, 0);
                return workoutDate.getTime() === today.getTime();
            });
        }

        // Get next 7 days workouts
        function getWeekWorkouts() {
            const today = getToday();
            const weekWorkouts = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                date.setHours(0, 0, 0, 0);
                
                const workout = trainingData.find(w => {
                    const workoutDate = parseDate(w.Date);
                    workoutDate.setHours(0, 0, 0, 0);
                    return workoutDate.getTime() === date.getTime();
                });
                
                weekWorkouts.push({
                    date: date,
                    isToday: i === 0,
                    workout: workout
                });
            }
            
            return weekWorkouts;
        }

        // Calculate stats
        function calculateStats() {
            const today = getToday();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            weekStart.setHours(0, 0, 0, 0);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            // Total distance
            const totalDistance = trainingData.reduce((sum, w) => sum + (w.Distance || 0), 0);
            
            // Week distance
            const weekDistance = trainingData
                .filter(w => {
                    const date = parseDate(w.Date);
                    return date >= weekStart && date <= weekEnd;
                })
                .reduce((sum, w) => sum + (w.Distance || 0), 0);
            
            // Days until race
            const raceDay = parseDate('30/11/2025');
            const daysUntilRace = Math.ceil((raceDay - today) / (1000 * 60 * 60 * 24));
            
            // Completed workouts
            const completed = trainingData.filter(w => {
                const date = parseDate(w.Date);
                return date < today;
            }).length;
            
            return {
                totalDistance: totalDistance.toFixed(1),
                weekDistance: weekDistance.toFixed(1),
                daysUntilRace: daysUntilRace > 0 ? daysUntilRace : 0,
                completed: completed
            };
        }

        // Render today's workout with weather
        function renderTodayWorkout(workout, weatherData) {
            if (!workout) {
                return `
                    <div class="today-section">
                        <div class="today-card">
                            <div class="no-workout">
                                <h2>📅 Không có lịch tập hôm nay</h2>
                                <p>Kiểm tra lịch tuần này bên dưới</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const date = formatDate(getToday());
            const isRaceDay = workout.Workout.toLowerCase().includes('race');
            
            let weatherHtml = '';
            if (weatherData && weatherData.current) {
                const runningTimes = getCurrentRunningTimes(weatherData.current);
                const weather = weatherData.current;
                
                if (runningTimes) {
                    const morningTemp = Math.round(runningTimes.morning.main.temp);
                    const eveningTemp = Math.round(runningTimes.evening.main.temp);
                    const morningTempClass = getTemperatureColor(morningTemp);
                    const eveningTempClass = getTemperatureColor(eveningTemp);
                    const icon = getWeatherIcon(weather.weather[0].icon);
                    
                    weatherHtml = `
                        <div class="today-weather">
                            <div class="weather-times">
                                <div class="weather-time-slot">
                                    <div class="time-label">🌅 Sáng sớm (4-6h)</div>
                                    <div class="time-weather">
                                        <div class="time-temp ${morningTempClass}">${morningTemp}°C</div>
                                        <div class="time-icon">${icon}</div>
                                    </div>
                                    <div class="time-desc">${weather.weather[0].description}</div>
                                </div>
                                <div class="weather-time-slot">
                                    <div class="time-label">🌆 Chiều muộn (17-18h)</div>
                                    <div class="time-weather">
                                        <div class="time-temp ${eveningTempClass}">${eveningTemp}°C</div>
                                        <div class="time-icon">${icon}</div>
                                    </div>
                                    <div class="time-desc">${weather.weather[0].description}</div>
                                </div>
                            </div>
                            <div class="weather-details">
                                <div class="weather-item">
                                    <span class="weather-icon">💧</span>
                                    <span>${weather.main.humidity}%</span>
                                </div>
                                <div class="weather-item">
                                    <span class="weather-icon">💨</span>
                                    <span>${Math.round(weather.wind.speed * 3.6)} km/h</span>
                                </div>
                                <div class="weather-item">
                                    <span class="weather-icon">👁️</span>
                                    <span>${Math.round(weather.visibility / 1000)} km</span>
                                </div>
                                <div class="weather-item">
                                    <span class="weather-icon">🌡️</span>
                                    <span>Hiện tại ${Math.round(weather.main.temp)}°C</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                weatherHtml = `
                    <div class="today-weather">
                        <div class="weather-loading">
                            <span class="mini-spinner"></span>
                            <span>Đang tải thời tiết...</span>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="today-section">
                    <div class="today-card">
                        <div class="today-header">
                            <span class="today-badge">${isRaceDay ? '🏁 NGÀY THI ĐẤU' : 'HÔM NAY'}</span>
                            <span class="today-date">${date.dayName}, ${date.dateStr}</span>
                        </div>
                        <div class="workout-main">
                            <div class="workout-title">${workout.Workout}</div>
                            <div class="workout-distance">${workout.Distance} km</div>
                            <span class="workout-type ${getWorkoutClass(workout.Workout)}">${workout.Workout}</span>
                        </div>
                        <div class="workout-details">
                            <div class="detail-row">
                                <span class="detail-label">Chi tiết bài tập</span>
                                <span class="detail-value">${workout.Description}</span>
                            </div>
                            ${workout.Notes ? `
                            <div class="detail-row">
                                <span class="detail-label">Lưu ý</span>
                                <span class="detail-value">${workout.Notes}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${weatherHtml}
                    </div>
                </div>
            `;
        }

        // Render stats
        function renderStats(stats) {
            return `
                <div class="stats-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">📊</div>
                            <div class="stat-value">${stats.totalDistance}</div>
                            <div class="stat-label">Tổng KM</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">📅</div>
                            <div class="stat-value">${stats.weekDistance}</div>
                            <div class="stat-label">KM tuần này</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🎯</div>
                            <div class="stat-value">${stats.daysUntilRace}</div>
                            <div class="stat-label">Ngày đến Race</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">✅</div>
                            <div class="stat-value">${stats.completed}</div>
                            <div class="stat-label">Đã hoàn thành</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render week view with weather
        function renderWeekView(weekWorkouts, weatherData) {
            const weekCards = weekWorkouts.map(day => {
                const formatted = formatDate(day.date);
                const workout = day.workout;
                
                let weatherHtml = '';
                if (weatherData) {
                    if (day.isToday && weatherData.current) {
                        // Hôm nay - dùng current weather với 2 khung giờ
                        const runningTimes = getCurrentRunningTimes(weatherData.current);
                        if (runningTimes) {
                            const morningTemp = Math.round(runningTimes.morning.main.temp);
                            const eveningTemp = Math.round(runningTimes.evening.main.temp);
                            const morningTempClass = getTemperatureColor(morningTemp);
                            const eveningTempClass = getTemperatureColor(eveningTemp);
                            const icon = getWeatherIcon(weatherData.current.weather[0].icon);
                            
                            weatherHtml = `
                                <div class="day-weather">
                                    <div class="day-weather-times">
                                        <div class="day-time-slot">
                                            <div class="day-time-label">🌅 Sáng</div>
                                            <div class="day-time-temp ${morningTempClass}">${morningTemp}°C</div>
                                            <div class="day-time-icon">${icon}</div>
                                        </div>
                                        <div class="day-time-slot">
                                            <div class="day-time-label">🌆 Chiều</div>
                                            <div class="day-time-temp ${eveningTempClass}">${eveningTemp}°C</div>
                                            <div class="day-time-icon">${icon}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } else if (weatherData.forecast) {
                        // Các ngày khác - dùng forecast với 2 khung giờ
                        const forecasts = getRunningTimeForecasts(weatherData.forecast, day.date);
                        if (forecasts && (forecasts.morning || forecasts.evening)) {
                            let morningHtml = '<div class="day-time-slot"><div class="day-time-label">🌅 Sáng</div><div style="font-size:0.7rem;color:#94a3b8;">N/A</div></div>';
                            let eveningHtml = '<div class="day-time-slot"><div class="day-time-label">🌆 Chiều</div><div style="font-size:0.7rem;color:#94a3b8;">N/A</div></div>';
                            
                            if (forecasts.morning) {
                                const temp = Math.round(forecasts.morning.main.temp);
                                const tempClass = getTemperatureColor(temp);
                                const icon = getWeatherIcon(forecasts.morning.weather[0].icon);
                                morningHtml = `
                                    <div class="day-time-slot">
                                        <div class="day-time-label">🌅 Sáng</div>
                                        <div class="day-time-temp ${tempClass}">${temp}°C</div>
                                        <div class="day-time-icon">${icon}</div>
                                    </div>
                                `;
                            }
                            
                            if (forecasts.evening) {
                                const temp = Math.round(forecasts.evening.main.temp);
                                const tempClass = getTemperatureColor(temp);
                                const icon = getWeatherIcon(forecasts.evening.weather[0].icon);
                                eveningHtml = `
                                    <div class="day-time-slot">
                                        <div class="day-time-label">🌆 Chiều</div>
                                        <div class="day-time-temp ${tempClass}">${temp}°C</div>
                                        <div class="day-time-icon">${icon}</div>
                                    </div>
                                `;
                            }
                            
                            weatherHtml = `
                                <div class="day-weather">
                                    <div class="day-weather-times">
                                        ${morningHtml}
                                        ${eveningHtml}
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
                
                if (!weatherHtml) {
                    weatherHtml = `
                        <div class="day-weather">
                            <div class="weather-loading">
                                <span class="mini-spinner"></span>
                                <span>Tải...</span>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="day-card ${day.isToday ? 'is-today' : ''}">
                        <div class="day-name">${formatted.dayName}</div>
                        <div class="day-date">${formatted.dateStr}</div>
                        <div class="day-workout">${workout ? workout.Workout : 'Không có'}</div>
                        <div class="day-distance">${workout ? workout.Distance + ' km' : '-'}</div>
                        ${weatherHtml}
                    </div>
                `;
            }).join('');
            
            return `
                <div class="week-section">
                    <h2 class="section-title">🗓️ Lịch tập 7 ngày tới</h2>
                    <div class="week-scroll">
                        <div class="week-container">
                            ${weekCards}
                        </div>
                    </div>
                </div>
            `;
        }

        // Main render function
        async function render() {
            const todayWorkout = getTodayWorkout();
            const weekWorkouts = getWeekWorkouts();
            const stats = calculateStats();
            
            // Render without weather first
            const html = `
                ${renderTodayWorkout(todayWorkout, null)}
                ${renderStats(stats)}
                ${renderWeekView(weekWorkouts, null)}
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            
            // Load weather data and re-render with weather
            const weatherData = await loadWeatherData();
            if (weatherData) {
                const htmlWithWeather = `
                    ${renderTodayWorkout(todayWorkout, weatherData)}
                    ${renderStats(stats)}
                    ${renderWeekView(weekWorkouts, weatherData)}
                `;
                document.getElementById('mainContent').innerHTML = htmlWithWeather;
            }
        }

        // Touch handling for better mobile experience
        let touchStartY = 0;
        let touchEndY = 0;
        
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }, { passive: true });
        
        function handleSwipe() {
            const swipeDistance = touchStartY - touchEndY;
            // Pull to refresh
            if (swipeDistance < -100 && window.scrollY === 0) {
                // Clear cache and refresh
                weatherCache = {
                    current: null,
                    forecast: null,
                    lastUpdate: null,
                    location: null
                };
                
                const locationInfo = document.getElementById('locationInfo');
                locationInfo.innerHTML = `
                    <span class="mini-spinner"></span>
                    <span>Đang làm mới...</span>
                `;
                
                setTimeout(() => render(), 300);
            }
        }

        // Service worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // You can register a service worker here for offline support
                // navigator.serviceWorker.register('/sw.js');
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                render();
            }, 500);
        });

        // Update at midnight
        function scheduleUpdate() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const msUntilMidnight = tomorrow - now;
            
            setTimeout(() => {
                // Clear weather cache at midnight
                weatherCache = {
                    current: null,
                    forecast: null,
                    lastUpdate: null,
                    location: null
                };
                render();
                scheduleUpdate();
            }, msUntilMidnight);
        }

        scheduleUpdate();

        // Visibility change handler - refresh when app comes back to foreground
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                render();
            }
        });

        // Add to home screen prompt (for PWA)
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // Prevent overscroll on iOS
        document.body.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>